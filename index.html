import React, { useState } from 'react';
import { Search, Download, FileText, Table2 } from 'lucide-react';

const PackageSubscriptionAnalyzer = () => {
  const [subscriptionData, setSubscriptionData] = useState('');
  const [checkData, setCheckData] = useState('');
  const [results, setResults] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);

  // ຟັງຊັນແປງວັນທີຈາກ DD/MM/YYYY-HH:MM ເປັນ YYYYMMDD
  const parseDate = (dateStr) => {
    try {
      // ຖ້າເປັນຮູບແບບ DD/MM/YYYY-HH:MM
      if (dateStr.includes('/') && dateStr.includes('-')) {
        const [datePart] = dateStr.split('-');
        const [day, month, year] = datePart.split('/');
        return `${year}${month.padStart(2, '0')}${day.padStart(2, '0')}`;
      }
      // ຖ້າເປັນຮູບແບບ YYYYMMDD ແລ້ວ
      if (dateStr.length === 8 && !isNaN(dateStr)) {
        return dateStr;
      }
      return null;
    } catch (error) {
      return null;
    }
  };

  // ຟັງຊັນແປງໝາຍເລກໂທ (ເອົາ 85620 ອອກ)
  const normalizePhoneNumber = (phone) => {
    if (!phone) return '';
    const cleanPhone = phone.toString().replace(/[^0-9]/g, '');
    if (cleanPhone.startsWith('85620')) {
      return cleanPhone.substring(3); // ເອົາ 856 ອອກ
    }
    return cleanPhone;
  };

  // ຟັງຊັນປະມວນຜົນຂໍ້ມູນ
  const processData = () => {
    if (!subscriptionData.trim() || !checkData.trim()) {
      alert('ກະລຸນາໃສ່ຂໍ້ມູນໃຫ້ຄົບຖ້ວນ');
      return;
    }

    setIsProcessing(true);

    try {
      // ແປງຂໍ້ມູນການສະໝັກ
      const subscriptionLines = subscriptionData.trim().split('\n');
      const subscriptions = [];
      
      subscriptionLines.forEach((line, index) => {
        if (index === 0) return; // ຂ້າມແຖວຫົວຕາຕະລາງ
        const parts = line.split('\t');
        if (parts.length >= 2) {
          subscriptions.push({
            date: parts[0],
            phone: normalizePhoneNumber(parts[1])
          });
        }
      });

      // ແປງຂໍ້ມູນທີ່ຕ້ອງກວດສອບ
      const checkLines = checkData.trim().split('\n');
      const checksToProcess = [];
      
      checkLines.forEach((line, index) => {
        if (index === 0) return; // ຂ້າມແຖວຫົວຕາຕະລາງ
        const parts = line.split('\t');
        if (parts.length >= 2) {
          checksToProcess.push({
            originalDate: parts[0],
            date: parseDate(parts[0]),
            phone: normalizePhoneNumber(parts[1]),
            originalPhone: parts[1]
          });
        }
      });

      // ປະມວນຜົນການກວດສອບ
      const analysisResults = checksToProcess.map(check => {
        // ຫາການສະໝັກທີ່ກົງກັນທັງວັນທີແລະໝາຍເລກ
        const exactMatch = subscriptions.find(sub => 
          sub.date === check.date && sub.phone === check.phone
        );

        // ຫາການສະໝັກທີ່ມີໝາຍເລກດຽວກັນແຕ່ວັນທີຕ່າງກັນ
        const phoneMatches = subscriptions.filter(sub => sub.phone === check.phone);
        
        let status = 'ບໍ່ພົບ';
        let note = '';

        if (exactMatch) {
          status = 'ພົບ';
          note = `ມີການສະໝັກວັນທີ ${check.date}`;
        } else if (phoneMatches.length > 0) {
          status = 'ບໍ່ພົບ';
          const otherDates = [...new Set(phoneMatches.map(m => m.date))];
          note = `ມີການສະໝັກໃນວັນອື່ນ: ${otherDates.join(', ')}`;
        } else {
          note = 'ບໍ່ພົບໝາຍເລກນີ້ໃນຂໍ້ມູນການສະໝັກທັງໝົດ';
        }

        return {
          checkDate: check.originalDate,
          phoneNumber: check.originalPhone,
          status: status,
          note: note
        };
      });

      setResults(analysisResults);
    } catch (error) {
      alert('ເກີດຂໍ້ຜິດພາດໃນການປະມວນຜົນຂໍ້ມູນ: ' + error.message);
    } finally {
      setIsProcessing(false);
    }
  };

  // ຟັງຊັນ Export ເປັນ CSV
  const exportToCSV = () => {
    if (results.length === 0) {
      alert('ບໍ່ມີຂໍ້ມູນທີ່ຈະ export');
      return;
    }

    const headers = ['ວັນທີກວດສອບ', 'ໝາຍເລກທີ່ຕ້ອງການກວດສອບ', 'ສະຖານະການສະໝັກ', 'ໝາຍເຫດ'];
    const csvContent = [
      headers.join(','),
      ...results.map(row => [
        `"${row.checkDate}"`,
        `"${row.phoneNumber}"`,
        `"${row.status}"`,
        `"${row.note}"`
      ].join(','))
    ].join('\n');

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ການວິເຄາະການສະໝັກແພັກເກັດ_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  // ຟັງຊັນ Export ເປັນ Excel format
  const exportToExcel = () => {
    if (results.length === 0) {
      alert('ບໍ່ມີຂໍ້ມູນທີ່ຈະ export');
      return;
    }

    const headers = ['ວັນທີກວດສອບ', 'ໝາຍເລກທີ່ຕ້ອງການກວດສອບ', 'ສະຖານະການສະໝັກ', 'ໝາຍເຫດ'];
    let excelContent = '<table border="1">';
    excelContent += '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
    
    results.forEach(row => {
      excelContent += '<tr>';
      excelContent += `<td>${row.checkDate}</td>`;
      excelContent += `<td>${row.phoneNumber}</td>`;
      excelContent += `<td>${row.status}</td>`;
      excelContent += `<td>${row.note}</td>`;
      excelContent += '</tr>';
    });
    excelContent += '</table>';

    const blob = new Blob(['\ufeff' + excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ການວິເຄາະການສະໝັກແພັກເກັດ_${new Date().toISOString().split('T')[0]}.xls`;
    link.click();
  };

  return (
    <div className="max-w-7xl mx-auto p-6 bg-gray-50 min-h-screen">
      <div className="bg-white rounded-lg shadow-lg p-6">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
            <Table2 className="text-blue-600" size={32} />
            ເຄື່ອງມືວິເຄາະຂໍ້ມູນການສະໝັກແພັກເກັດ
          </h1>
          <p className="text-gray-600">ກວດສອບການສະໝັກແພັກເກັດຕາມໝາຍເລກໂທແລະວັນທີທີ່ກຳນົດ</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {/* ກ່ອງທີ 1: ຂໍ້ມູນການສະໝັກ */}
          <div className="space-y-3">
            <label className="block text-lg font-semibold text-gray-700 flex items-center gap-2">
              <FileText size={20} className="text-blue-600" />
              ກ່ອງທີ 1: ຂໍ້ມູນລາຍການສະໝັກແພັກເກັດທັງໝົດ
            </label>
            <textarea
              value={subscriptionData}
              onChange={(e) => setSubscriptionData(e.target.value)}
              placeholder="ວັນທີ	ໝາຍເລກ	ຈຳນວນຄັ້ງສະໝັກ	ລາຄາແພັກເກັດ	ຊື່ແພັກເກັດ	ຊ່ອງທາງ
20250603	205155xxxx	1	10000	10000/4.5GB/3day	USSD
20250604	205155xxxx	1	10000	10000/4.5GB/3day	USSD
..."
              className="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
            />
            <p className="text-sm text-gray-500">
              * Copy ແລະ paste ຂໍ້ມູນຈາກ Excel ຫຼື CSV (ຄັ້ນດ້ວຍ Tab)
            </p>
          </div>

          {/* ກ່ອງທີ 2: ລາຍການກວດສອບ */}
          <div className="space-y-3">
            <label className="block text-lg font-semibold text-gray-700 flex items-center gap-2">
              <Search size={20} className="text-green-600" />
              ກ່ອງທີ 2: ລາຍການເບີແລະວັນທີທີ່ຕ້ອງກວດ
            </label>
            <textarea
              value={checkData}
              onChange={(e) => setCheckData(e.target.value)}
              placeholder="ວັນທີ	ໝາຍເລກ
04/06/2025-11:27	856205199xxxx
05/06/2025-00:00	856205443xxxx
05/06/2025-11:29	205579xxxx
..."
              className="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent font-mono text-sm"
            />
            <p className="text-sm text-gray-500">
              * ຮູບແບບວັນທີ: DD/MM/YYYY-HH:MM ຫຼື YYYYMMDD
            </p>
          </div>
        </div>

        {/* ປຸ່ມກວດສອບ */}
        <div className="text-center mb-8">
          <button
            onClick={processData}
            disabled={isProcessing}
            className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 flex items-center gap-2 mx-auto"
          >
            <Search size={20} />
            {isProcessing ? 'ກຳລັງປະມວນຜົນ...' : 'ເລີ່ມກວດສອບ'}
          </button>
        </div>

        {/* ຜົນການກວດສອບ */}
        {results.length > 0 && (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold text-gray-800">ຜົນການກວດສອບ</h2>
              <div className="flex gap-3">
                <button
                  onClick={exportToCSV}
                  className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2"
                >
                  <Download size={16} />
                  Export CSV
                </button>
                <button
                  onClick={exportToExcel}
                  className="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2"
                >
                  <Download size={16} />
                  Export Excel
                </button>
              </div>
            </div>

            <div className="overflow-x-auto bg-white rounded-lg border">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ວັນທີກວດສອບ
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ໝາຍເລກທີ່ຕ້ອງການກວດສອບ
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ສະຖານະການສະໝັກ
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ໝາຍເຫດ
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {results.map((row, index) => (
                    <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {row.checkDate}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        {row.phoneNumber}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                          row.status === 'ພົບ' 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {row.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {row.note}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="bg-blue-50 p-4 rounded-lg">
              <h3 className="font-semibold text-blue-800 mb-2">ສະຫລຸບຜົນການວິເຄາະ:</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div className="bg-white p-3 rounded border-l-4 border-green-500">
                  <div className="font-semibold text-green-700">ພົບການສະໝັກ</div>
                  <div className="text-2xl font-bold text-green-600">
                    {results.filter(r => r.status === 'ພົບ').length}
                  </div>
                </div>
                <div className="bg-white p-3 rounded border-l-4 border-red-500">
                  <div className="font-semibold text-red-700">ບໍ່ພົບການສະໝັກ</div>
                  <div className="text-2xl font-bold text-red-600">
                    {results.filter(r => r.status === 'ບໍ່ພົບ').length}
                  </div>
                </div>
                <div className="bg-white p-3 rounded border-l-4 border-blue-500">
                  <div className="font-semibold text-blue-700">ທັງໝົດ</div>
                  <div className="text-2xl font-bold text-blue-600">
                    {results.length}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ຄຳແນະນຳການໃຊ້ງານ */}
        <div className="mt-8 bg-gray-50 p-4 rounded-lg">
          <h3 className="font-semibold text-gray-700 mb-2">ຄຳແນະນຳການໃຊ້ງານ:</h3>
          <ul className="text-sm text-gray-600 space-y-1 list-disc list-inside">
            <li>Copy ຂໍ້ມູນຈາກ Excel ຫຼື CSV ໂດຍລວມຫົວຕາຕະລາງ</li>
            <li>ຂໍ້ມູນຕ້ອງຄັ້ນກັນດ້ວຍ Tab (ໃຊ້ Ctrl+C, Ctrl+V ຈາກ Excel)</li>
            <li>ວັນທີສາມາດເປັນຮູບແບບ DD/MM/YYYY-HH:MM ຫຼື YYYYMMDD</li>
            <li>ໝາຍເລກໂທສາມາດມີ ຫຼື ບໍ່ມີຄຳນຳໜ້າ 85620 ກໍໄດ້</li>
            <li>ສາມາດ Export ຜົນການວິເຄາະເປັນ CSV ຫຼື Excel ໄດ້</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default PackageSubscriptionAnalyzer;